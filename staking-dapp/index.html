<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DogeRocket Staking dApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    body { overflow-y: auto; }
  </style>
</head>
<body class="bg-gradient-to-b from-blue-900 to-blue-500 text-white min-h-screen font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { ethers } = window.ethers;

    // NEW CONTRACTS
    const TOKEN_ADDRESS = "0x78835AE70722A6Aa03aAA5d4501E3e0460f723f9";   // DRKT token (ERC20 + vesting/locked)
    const STAKING_ADDRESS = "0xf67eec63ef76f59233fc6ee8ef849ca2d42c6d4e";  // Staking contract
    const CHAIN_ID = 137;
    const RPC_URL = "https://polygon-rpc.com";
    const LOGO_URL = "https://gray-past-falcon-384.mypinata.cloud/ipfs/bafkreign7g276yq7ss6cqo7gtnrbvwrh5qbxmhgboamwdoiy5sv5lo6j4i";
    const SALE_URL = "https://dapp.quickswap.exchange/swap/v3/ETH/0x78835AE70722A6Aa03aAA5d4501E3e0460f723f9";

    // Minimal ERC20 ABI for token contract
    const ERC20_ABI = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function balanceOf(address) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    // Full original staking ABI (functions are the same in the new staking contract)
    const STAKING_ABI = [
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"allowance","type":"uint256"},{"internalType":"uint256","name":"needed","type":"uint256"}],"name":"ERC20InsufficientAllowance","type":"error"},
      {"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"needed","type":"uint256"}],"name":"ERC20InsufficientBalance","type":"error"},
      {"inputs":[{"internalType":"address","name":"approver","type":"address"}],"name":"ERC20InvalidApprover","type":"error"},
      {"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"name":"ERC20InvalidReceiver","type":"error"},
      {"inputs":[{"internalType":"address","name":"sender","type":"address"}],"name":"ERC20InvalidSender","type":"error"},
      {"inputs":[{"internalType":"address","name":"spender","type":"address"}],"name":"ERC20InvalidSpender","type":"error"},
      {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},
      {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},
      {"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"SafeERC20FailedOperation","type":"error"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"wallet","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LockedTokensClaimed","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"newCID","type":"string"},{"indexed":false,"internalType":"string","name":"newDescription","type":"string"}],"name":"MetadataUpdated","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"RewardClaimed","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardPoolContribution","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"previousPool","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newPool","type":"uint256"}],"name":"RewardPoolModified","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardsExpired","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"StakePruned","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokensStaked","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"fee","type":"uint256"}],"name":"TokensUnstaked","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"wallet","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"VestedTokensClaimed","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},
      {"inputs":[],"name":"claimReward","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"currentAPY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"dogeStakes","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"pendingRewards","type":"uint256"},{"internalType":"uint64","name":"lastUpdateTime","type":"uint64"},{"internalType":"uint64","name":"lastActionTime","type":"uint64"},{"internalType":"uint64","name":"stakeStartTime","type":"uint64"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"donateToPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"rewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"totalStaked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"calculateReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    function App() {
      const [provider, setProvider] = useState(null);
      const [signer, setSigner] = useState(null);
      const [tokenContract, setTokenContract] = useState(null);
      const [stakingContract, setStakingContract] = useState(null);
      const [account, setAccount] = useState(null);
      const [balance, setBalance] = useState("0");
      const [apy, setApy] = useState("0");
      const [totalStaked, setTotalStaked] = useState("0");
      const [rewardPool, setRewardPool] = useState("0");
      const [userStake, setUserStake] = useState("0");
      const [pendingRewards, setPendingRewards] = useState("0");
      const [stakeAmount, setStakeAmount] = useState("");
      const [unstakeAmount, setUnstakeAmount] = useState("");
      const [donateAmount, setDonateAmount] = useState("");
      const [error, setError] = useState("");
      const [loading, setLoading] = useState(false);

      // Initial load (global data from staking contract)
      useEffect(() => {
        const init = async () => {
          const rpc = new ethers.providers.JsonRpcProvider(RPC_URL);
          const staking = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, rpc);
          setProvider(rpc);
          setStakingContract(staking);

          const [apyRaw, totalRaw, poolRaw] = await Promise.all([
            staking.currentAPY(),
            staking.totalStaked(),
            staking.rewardPool()
          ]);
          setApy((Number(ethers.utils.formatUnits(apyRaw, 0)) / 100).toFixed(2));
          setTotalStaked(ethers.utils.formatEther(totalRaw));
          setRewardPool(ethers.utils.formatEther(poolRaw));
        };
        init();
      }, []);

      const connectWallet = async () => {
        if (!window.ethereum) return setError("Please install MetaMask or another wallet");
        setLoading(true);
        setError("");
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const prov = new ethers.providers.Web3Provider(window.ethereum);
          const network = await prov.getNetwork();
          if (network.chainId !== CHAIN_ID) {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: `0x${CHAIN_ID.toString(16)}` }],
            });
          }
          const signerInst = prov.getSigner();
          const addr = await signerInst.getAddress();

          const token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signerInst);
          const staking = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signerInst);

          setProvider(prov);
          setSigner(signerInst);
          setTokenContract(token);
          setStakingContract(staking);
          setAccount(addr);

          await refreshUserData(addr, token, staking);
        } catch (e) {
          setError(e?.message || "Connection failed");
        } finally {
          setLoading(false);
        }
      };

      const refreshUserData = async (addr, token = tokenContract, staking = stakingContract) => {
        if (!token || !staking) return;
        const [bal, stakeInfo, rew, totalS, pool, apyRaw] = await Promise.all([
          token.balanceOf(addr),
          staking.dogeStakes(addr),
          staking.calculateReward(addr),
          staking.totalStaked(),
          staking.rewardPool(),
          staking.currentAPY()
        ]);
        setBalance(ethers.utils.formatEther(bal));
        setUserStake(ethers.utils.formatEther(stakeInfo.amount));
        setPendingRewards(ethers.utils.formatEther(rew));
        setTotalStaked(ethers.utils.formatEther(totalS));
        setRewardPool(ethers.utils.formatEther(pool));
        setApy((Number(ethers.utils.formatUnits(apyRaw, 0)) / 100).toFixed(2));
      };

      const handleStake = async () => {
        if (!stakeAmount || Number(stakeAmount) <= 0) return setError("Invalid amount");
        setLoading(true);
        try {
          const amount = ethers.utils.parseEther(stakeAmount);
          const approveTx = await tokenContract.approve(STAKING_ADDRESS, amount);
          await approveTx.wait();
          const tx = await stakingContract.stake(amount);
          await tx.wait();
          setStakeAmount("");
          await refreshUserData(account);
        } catch (e) { setError(e?.reason || e?.message || "Stake failed"); }
        setLoading(false);
      };

      const handleUnstake = async () => {
        if (!unstakeAmount || Number(unstakeAmount) <= 0) return setError("Invalid amount");
        setLoading(true);
        try {
          const amount = ethers.utils.parseEther(unstakeAmount);
          const tx = await stakingContract.unstake(amount);
          await tx.wait();
          setUnstakeAmount("");
          await refreshUserData(account);
        } catch (e) { setError(e?.reason || e?.message || "Unstake failed"); }
        setLoading(false);
      };

      const handleClaimRewards = async () => {
        setLoading(true);
        try {
          const tx = await stakingContract.claimReward();
          await tx.wait();
          await refreshUserData(account);
        } catch (e) { setError(e?.reason || e?.message || "Claim failed"); }
        setLoading(false);
      };

      const handleDonate = async () => {
        if (!donateAmount || Number(donateAmount) <= 0) return setError("Invalid amount");
        setLoading(true);
        try {
          const amount = ethers.utils.parseEther(donateAmount);
          const approveTx = await tokenContract.approve(STAKING_ADDRESS, amount);
          await approveTx.wait();
          const tx = await stakingContract.donateToPool(amount);
          await tx.wait();
          setDonateAmount("");
          await refreshUserData(account);
        } catch (e) { setError(e?.reason || e?.message || "Donate failed"); }
        setLoading(false);
      };

      const addTokenToWallet = async () => {
        try {
          await window.ethereum.request({
            method: 'wallet_watchAsset',
            params: { type: 'ERC20', options: { address: TOKEN_ADDRESS, symbol: 'DRKT', decimals: 18, image: LOGO_URL } }
          });
        } catch { }
      };

      return (
        <div className="container mx-auto px-4 py-8">
          {error && (
            <div className="fixed top-4 left-4 right-4 bg-red-600/90 border border-red-500 p-4 rounded-lg z-50 flex justify-between">
              <span>{error}</span>
              <button onClick={() => setError("")} className="text-xl">×</button>
            </div>
          )}

          <header className="text-center py-12">
            <img src={LOGO_URL} alt="DRKT" className="w-24 h-24 mx-auto rounded-full border-4 border-yellow-400 mb-4" />
            <h1 className="text-5xl font-bold mb-3">DogeRocket Staking</h1>
            <p className="text-xl text-gray-300">Elevate your portfolio to stellar heights</p>

            <div className="mt-10 flex flex-col sm:flex-row justify-center gap-6 items-center">
              {!account ? (
                <button onClick={connectWallet} disabled={loading}
                  className="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-10 rounded-full flex items-center gap-3 text-lg transition">
                  <i className="ri-wallet-3-line text-2xl"></i>
                  {loading ? "Connecting..." : "Connect Wallet"}
                </button>
              ) : (
                <div className="flex items-center gap-4">
                  <span className="bg-white/10 px-5 py-3 rounded-full font-mono">
                    {account.slice(0,6)}...{account.slice(-4)}
                  </span>
                  <button onClick={() => window.location.reload()} className="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-full">
                    Disconnect
                  </button>
                </div>
              )}

              <div className="flex gap-4">
                <a href={SALE_URL} target="_blank" rel="noopener noreferrer"
                  className="bg-green-600 hover:bg-green-500 px-8 py-4 rounded-full font-bold flex items-center gap-2">
                  <i className="ri-swap-line"></i> Swap on Quickswap
                </a>
                <button onClick={addTokenToWallet}
                  className="bg-gray-700 hover:bg-gray-600 px-6 py-4 rounded-full flex items-center gap-2">
                  <i className="ri-add-circle-line"></i> Add DRKT
                </button>
              </div>
            </div>
          </header>

          <section className="bg-white/10 backdrop-blur-sm rounded-xl p-8 mb-8 text-center">
            <h2 className="text-3xl font-bold mb-6">About DogeRocket</h2>
            <p className="text-lg text-gray-200 leading-relaxed mb-6">
              DogeRocket (DRKT) is a decentralized ERC-20 staking token on Polygon with a fixed 1B supply.
              Dynamic APY from 5.8% to 347%. 20% 10-year vest to DogeDAO • 40% staking rewards • 30% locked pool.
            </p>
            <div className="flex justify-center gap-8 text-blue-300">
              <a href="https://dogerocket.site" target="_blank" rel="noopener noreferrer" className="hover:text-white"><i className="ri-global-line text-2xl"></i> Website</a>
              <a href="https://x.com/DRKTDogeRocket" target="_blank" rel="noopener noreferrer" className="hover:text-white"><i className="ri-twitter-x-line text-2xl"></i> X</a>
              <a href="https://discord.gg/9QQ8FmY6nq" target="_blank" rel="noopener noreferrer" className="hover:text-white"><i className="ri-discord-line text-2xl"></i> Discord</a>
            </div>
          </section>

          <section className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div className="bg-white/10 backdrop-blur-sm p-8 rounded-xl text-center">
              <h3 className="text-xl text-gray-300">Current APY</h3>
              <p className="text-5xl font-bold text-yellow-400">{apy}%</p>
            </div>
            <div className="bg-white/10 backdrop-blur-sm p-8 rounded-xl text-center">
              <h3 className="text-xl text-gray-300">Total Staked</h3>
              <p className="text-4xl font-bold">{parseFloat(totalStaked).toLocaleString(undefined,{maximumFractionDigits:0})} DRKT</p>
            </div>
            <div className="bg-white/10 backdrop-blur-sm p-8 rounded-xl text-center">
              <h3 className="text-xl text-gray-300">Reward Pool</h3>
              <p className="text-4xl font-bold">{parseFloat(rewardPool).toLocaleString(undefined,{maximumFractionDigits:0})} DRKT</p>
            </div>
          </section>

          {account && (
            <section className="bg-white/10 backdrop-blur-sm rounded-xl p-8">
              <h2 className="text-3xl font-bold text-center mb-8">Your Dashboard</h2>
              <div className="grid md:grid-cols-2 gap-10">
                <div className="space-y-6">
                  <div className="bg-blue-900/50 p-6 rounded-xl"><h3 className="text-xl text-gray-300">Wallet Balance</h3><p className="text-4xl font-bold text-yellow-400">{parseFloat(balance).toLocaleString()} DRKT</p></div>
                  <div className="bg-blue-900/50 p-6 rounded-xl"><h3 className="text-xl text-gray-300">Staked</h3><p className="text-4xl font-bold text-cyan-400">{parseFloat(userStake).toLocaleString()} DRKT</p></div>
                  <div className="bg-green-900/50 p-6 rounded-xl"><h3 className="text-xl text-gray-300">Pending Rewards</h3><p className="text-4xl font-bold text-green-400">{parseFloat(pendingRewards).toLocaleString()} DRKT</p></div>
                </div>
                <div className="space-y-6">
                  <div><input type="number" step="0.000000000000000001" value={stakeAmount} onChange={e=>setStakeAmount(e.target.value)} placeholder="0.0 DRKT" className="w-full p-4 bg-white/10 rounded-lg text-lg text-white"/><button onClick={handleStake} disabled={loading} className="mt-3 w-full bg-green-600 hover:bg-green-500 py-4 rounded-full font-bold text-xl disabled:opacity-50">Stake</button></div>
                  <div><input type="number" step="0.000000000000000001" value={unstakeAmount} onChange={e=>setUnstakeAmount(e.target.value)} placeholder="0.0 DRKT" className="w-full p-4 bg-white/10 rounded-lg text-lg text-white"/><button onClick={handleUnstake} disabled={loading} className="mt-3 w-full bg-red-600 hover:bg-red-500 py-4 rounded-full font-bold text-xl disabled:opacity-50">Unstake</button></div>
                  <div><input type="number" step="0.000000000000000001" value={donateAmount} onChange={e=>setDonateAmount(e.target.value)} placeholder="0.0 DRKT" className="w-full p-4 bg-white/10 rounded-lg text-lg text-white"/><button onClick={handleDonate} disabled={loading} className="mt-3 w-full bg-purple-600 hover:bg-purple-500 py-4 rounded-full font-bold text-xl disabled:opacity-50">Donate</button></div>
                  <button onClick={handleClaimRewards} disabled={loading || Number(pendingRewards)===0} className="w-full bg-yellow-600 hover:bg-yellow-500 py-5 rounded-full font-bold text-xl disabled:opacity-50">
                    {loading ? "Claiming..." : `Claim ${parseFloat(pendingRewards).toLocaleString()} DRKT Rewards`}
                  </button>
                </div>
              </div>
            </section>
          )}

          <footer className="text-center py-12 text-gray-400 border-t border-white/10 mt-16">
            © 2025 DogeRocket • Polygon Mainnet • All Rights Reserved
          </footer>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
