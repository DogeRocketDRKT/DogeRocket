<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DogeRocket Staking - 300% APY</title>
  <link rel="icon" href="https://gray-past-falcon-384.mypinata.cloud/ipfs/bafkreign7g276yq7ss6cqo7gtnrbvwrh5qbxmhgboamwdoiy5sv5lo6j4i" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'drkt-blue': '#001F3F',
            'drkt-cyan': '#00D4FF'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-b from-drkt-blue to-black text-white min-h-screen font-sans">
  <div id="root"></div>

  <!-- React + Babel + Ethers + Web3Modal -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@web3modal/ethers5@3.5.4/dist/index.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { ethers } = window.ethers;

    // === CONFIG ===
    const CONTRACT_ADDRESS = "0x03720cc99a302c101dbd48489a6c2c8bb52d178d";
    const CHAIN_ID = 137;
    const RPC_URL = `https://polygon-mainnet.infura.io/v3/${import.meta.env.VITE_INFURA_KEY || 'YOUR_INFURA_KEY'}`;
    const PROJECT_ID = import.meta.env.VITE_WALLET_CONNECT_PROJECT_ID || 'YOUR_WC_PROJECT_ID';

    // === FULL ABI (from PolygonScan) ===
    const ABI = [
      {"inputs":[],"name":"claimReward","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"donateToPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"calculateReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"currentAPY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"dogeStakes","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"pendingRewards","type":"uint256"},{"internalType":"uint64","name":"lastUpdateTime","type":"uint64"},{"internalType":"uint64","name":"lastActionTime","type":"uint64"},{"internalType":"uint64","name":"stakeStartTime","type":"uint64"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"rewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"totalStaked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    // === Web3Modal Init ===
    let modal = null;
    if (window.Web3Modal?.Web3Modal) {
      modal = new window.Web3Modal.Web3Modal({
        projectId: PROJECT_ID,
        themeMode: "dark"
      });
    }

    function App() {
      const [account, setAccount] = useState("");
      const [signer, setSigner] = useState(null);
      const [contract, setContract] = useState(null);
      const [balance, setBalance] = useState("0");
      const [apy, setApy] = useState("0");
      const [totalStaked, setTotalStaked] = useState("0");
      const [rewardPool, setRewardPool] = useState("0");
      const [userStake, setUserStake] = useState("0");
      const [pending, setPending] = useState("0");
      const [stakeAmt, setStakeAmt] = useState("");
      const [unstakeAmt, setUnstakeAmt] = useState("");
      const [donateAmt, setDonateAmt] = useState("");
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");

      // Init public data
      useEffect(() => {
        const init = async () => {
          const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
          setContract(c);
          try {
            const [a, ts, rp] = await Promise.all([
              c.currentAPY(),
              c.totalStaked(),
              c.rewardPool()
            ]);
            setApy((Number(a) / 100).toFixed(1));
            setTotalStaked(ethers.utils.formatEther(ts));
            setRewardPool(ethers.utils.formatEther(rp));
          } catch (e) { console.error(e); }
        };
        init();
      }, []);

      const connect = async () => {
        if (!modal) return setError("WalletConnect not loaded");
        setLoading(true);
        try {
          const instance = await modal.connect();
          const provider = new ethers.providers.Web3Provider(instance);
          const s = provider.getSigner();
          const addr = await s.getAddress();
          const net = await provider.getNetwork();
          if (net.chainId !== CHAIN_ID) throw new Error("Switch to Polygon");
          setSigner(s);
          setAccount(addr);
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, s);
          setContract(c);
          await refreshUser(c, addr);
        } catch (e) {
          setError(e.message);
        }
        setLoading(false);
      };

      const refreshUser = async (c, addr) => {
        const [bal, stake, rew] = await Promise.all([
          c.balanceOf(addr),
          c.dogeStakes(addr),
          c.calculateReward(addr)
        ]);
        setBalance(ethers.utils.formatEther(bal));
        setUserStake(ethers.utils formatEther(stake.amount));
        setPending(ethers.utils.formatEther(rew));
      };

      const stake = async () => {
        setLoading(true); setError("");
        try {
          const amt = ethers.utils.parseEther(stakeAmt);
          let tx = await contract.approve(CONTRACT_ADDRESS, amt);
          await tx.wait();
          tx = await contract.stake(amt);
          await tx.wait();
          setStakeAmt("");
          await refreshUser(contract, account);
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const unstake = async () => {
        setLoading(true); setError("");
        try {
          const amt = ethers.utils.parseEther(unstakeAmt);
          const tx = await contract.unstake(amt);
          await tx.wait();
          setUnstakeAmt("");
          await refreshUser(contract, account);
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const claim = async () => {
        setLoading(true); setError("");
        try {
          const tx = await contract.claimReward();
          await tx.wait();
          await refreshUser(contract, account);
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const donate = async () => {
        setLoading(true); setError("");
        try {
          const amt = ethers.utils.parseEther(donateAmt);
          let tx = await contract.approve(CONTRACT_ADDRESS, amt);
          await tx.wait();
          tx = await contract.donateToPool(amt);
          await tx.wait();
          setDonateAmt("");
          const rp = await contract.rewardPool();
          setRewardPool(ethers.utils.formatEther(rp));
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      return (
        <div className="container mx-auto px-4 py-8 max-w-6xl">
          {/* Header */}
          <header className="text-center py-12">
            <img src="https://gray-past-falcon-384.mypinata.cloud/ipfs/bafkreign7g276yq7ss6cqo7gtnrbvwrh5qbxmhgboamwdoiy5sv5lo6j4i" alt="DRKT" className="w-24 h-24 mx-auto rounded-full border-4 border-drkt-cyan" />
            <h1 className="text-5xl font-bold mt-4 bg-clip-text text-transparent bg-gradient-to-r from-drkt-cyan to-purple-400">DogeRocket Staking</h1>
            <p className="text-xl mt-2">Stake DRKT • Earn Up To 300% APY</p>
            <button onClick={connect} disabled={loading} className="mt-6 bg-gradient-to-r from-drkt-cyan to-purple-600 hover:from-drkt-cyan/80 px-8 py-3 rounded-full font-bold text-lg">
              {loading ? "..." : account ? `${account.slice(0,6)}...${account.slice(-4)}` : "Connect Wallet"}
            </button>
          </header>

          {/* Stats */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div className="bg-white/10 backdrop-blur rounded-2xl p-6 text-center border border-drkt-cyan/30">
              <p className="text-drkt-cyan text-sm">Current APY</p>
              <p className="text-3xl font-bold">{apy}%</p>
            </div>
            <div className="bg-white/10 backdrop-blur rounded-2xl p-6 text-center border border-drkt-cyan/30">
              <p className="text-drkt-cyan text-sm">Total Staked</p>
              <p className="text-3xl font-bold">{Number(totalStaked).toLocaleString()} DRKT</p>
            </div>
            <div className="bg-white/10 backdrop-blur rounded-2xl p-6 text-center border border-drkt-cyan/30">
              <p className="text-drkt-cyan text-sm">Reward Pool</p>
              <p className="text-3xl font-bold">{Number(rewardPool).toLocaleString()} DRKT</p>
            </div>
          </div>

          {/* Dashboard */}
          {account && (
            <div className="bg-white/5 backdrop-blur rounded-3xl p-8 border border-drkt-cyan/30">
              <h2 className="text-3xl font-bold mb-6 text-center">Your Dashboard</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div className="bg-gradient-to-br from-drkt-cyan/20 to-purple-600/20 rounded-2xl p-6 text-center">
                  <p className="text-drkt-cyan">Wallet Balance</p>
                  <p className="text-2xl font-bold">{Number(balance).toFixed(2)} DRKT</p>
                </div>
                <div className="bg-gradient-to-br from-green-500/20 to-teal-600/20 rounded-2xl p-6 text-center">
                  <p className="text-drkt-cyan">Staked</p>
                  <p className="text-2xl font-bold">{Number(userStake).toFixed(2)} DRKT</p>
                </div>
                <div className="bg-gradient-to-br from-yellow-500/20 to-orange-600/20 rounded-2xl p-6 text-center">
                  <p className="text-drkt-cyan">Pending Rewards</p>
                  <p className="text-2xl font-bold">{Number(pending).toFixed(2)} DRKT</p>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-white/10 rounded-2xl p-6">
                  <input value={stakeAmt} onChange={e => setStakeAmt(e.target.value)} placeholder="100" className="w-full p-3 rounded bg-white/20 text-white placeholder-gray-400 mb-3" />
                  <button onClick={stake} disabled={loading} className="w-full bg-drkt-cyan hover:bg-drkt-cyan/80 text-black font-bold py-3 rounded">
                    {loading ? "..." : "Stake"}
                  </button>
                </div>
                <div className="bg-white/10 rounded-2xl p-6">
                  <input value={unstakeAmt} onChange={e => setUnstakeAmt(e.target.value)} placeholder="100" className="w-full p-3 rounded bg-white/20 text-white placeholder-gray-400 mb-3" />
                  <button onClick={unstake} disabled={loading} className="w-full bg-red-600 hover:bg-red-500 font-bold py-3 rounded">
                    {loading ? "..." : "Unstake (2% fee)"}
                  </button>
                </div>
                <div className="bg-white/10 rounded-2xl p-6">
                  <input value={donateAmt} onChange={e => setDonateAmt(e.target.value)} placeholder="100" className="w-full p-3 rounded bg-white/20 text-white placeholder-gray-400 mb-3" />
                  <button onClick={donate} disabled={loading} className="w-full bg-purple-600 hover:bg-purple-500 font-bold py-3 rounded">
                    {loading ? "..." : "Donate"}
                  </button>
                </div>
                <div className="bg-white/10 rounded-2xl p-6 flex items-center justify-center">
                  <button onClick={claim} disabled={loading} className="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-400 hover:to-teal-500 font-bold py-8 rounded text-xl">
                    {loading ? "Claiming..." : `Claim ${Number(pending).toFixed(2)} DRKT`}
                  </button>
                </div>
              </div>
              {error && <p className="text-red-400 text-center mt-6">{error}</p>}
            </div>
          )}

          {/* Footer */}
          <footer className="text-center py-12 text-gray-400 text-sm">
            <p>© 2025 DogeRocket – All Rights Reserved</p>
            <div className="flex justify-center gap-6 mt-4">
              <a href="https://x.com/DRKTDogeRocket" className="hover:text-drkt-cyan">Twitter</a>
              <a href="https://discord.gg/9QQ8FmY6nq" className="hover:text-drkt-cyan">Discord</a>
              <a href="https://polygonscan.com/token/0x03720cc99a302c101dbd48489a6c2c8bb52d178d" className="hover:text-drkt-cyan">Contract</a>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
